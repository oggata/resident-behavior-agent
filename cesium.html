<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªå¾‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ with AI</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            overflow: hidden;
        }
        
        #cesiumContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        #control-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(20, 20, 20, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            max-width: 300px;
            z-index: 1000;
        }
        
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(20, 20, 20, 0.95);
            padding: 15px;
            border-radius: 8px;
            max-width: 280px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        #info-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        #info-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        #info-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .input-group {
            margin-bottom: 10px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .input-group input[type="text"], .input-group input[type="password"], .input-group input[type="number"] {
            width: 100%;
            padding: 6px;
            margin: 6px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }
        
        button {
            padding: 6px 12px;
            margin: 6px 0;
            cursor: pointer;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .agent-card {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .agent-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .agent-name {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .agent-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-active {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .agent-info-row {
            margin: 3px 0;
            font-size: 12px;
            color: #b0b0b0;
        }
        
        .agent-thought {
            font-style: italic;
            color: #80cbc4;
            margin-top: 6px;
            padding: 6px;
            background: rgba(128, 203, 196, 0.1);
            border-radius: 4px;
            border-left: 3px solid #80cbc4;
            font-size: 12px;
        }
        
        .agent-memory {
            margin-top: 6px;
            font-size: 11px;
        }
        
        .memory-item {
            padding: 3px 6px;
            margin: 2px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
            color: #888;
        }
        
        .relationship-info {
            margin-top: 6px;
            font-size: 11px;
        }
        
        .relationship-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
        }
        
        .relationship-bar {
            width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .relationship-fill {
            height: 100%;
            background: linear-gradient(to right, #ff6b6b, #ffd93d, #6bcf7f);
            transition: width 0.3s ease;
        }
        
        #log-panel {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(20, 20, 20, 0.95);
            padding: 12px;
            border-radius: 8px;
            max-width: 350px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .log-entry {
            margin: 6px 0;
            padding: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
            font-size: 11px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .log-thought {
            border-left-color: #80cbc4;
            color: #80cbc4;
        }
        
        .log-interaction {
            border-left-color: #FFC107;
            color: #FFC107;
        }
        
        .log-movement {
            border-left-color: #2196F3;
            color: #2196F3;
        }
        
        .time-display {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            color: #4CAF50;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .warning {
            color: #ff9800;
            font-size: 11px;
            margin-top: 8px;
            padding: 8px;
            background: rgba(255, 152, 0, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .thinking-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 1.5s infinite;
            margin-left: 8px;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .log-entry {
            margin: 8px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            font-size: 13px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .log-thought {
            border-left-color: #80cbc4;
            color: #80cbc4;
        }
        
        .log-interaction {
            border-left-color: #FFC107;
            color: #FFC107;
        }
        
        .log-movement {
            border-left-color: #2196F3;
            color: #2196F3;
        }
        
        .log-relationship {
            border-left-color: #E91E63;
            color: #E91E63;
        }
        
        .log-details-toggle {
            margin-top: 5px;
            cursor: pointer;
            color: #888;
            font-size: 12px;
        }
        
        .log-details-toggle:hover {
            color: #fff;
        }
        
        .log-details {
            margin-top: 6px;
            padding: 6px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 3px;
            font-size: 11px;
        }
        
        .log-detail-section {
            margin-bottom: 6px;
        }
        
        .log-detail-section h4 {
            margin: 0 0 4px 0;
            color: #4CAF50;
            font-size: 11px;
        }
        
        .agent-name {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .relationship-change {
            color: #E91E63;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div class="time-display" id="time-display">
        åˆå‰ 8:00
    </div>
    
    <div id="control-panel">
        <h3 class="panel-title">ğŸ”§ åˆ¶å¾¡ãƒ‘ãƒãƒ«</h3>
        <div class="input-group">
            <label for="apiKey">OpenAI APIã‚­ãƒ¼:</label>
            <input type="password" id="apiKey" placeholder="OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›">
        </div>
        <div class="input-group">
            <label for="cesiumKey">Cesium ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³:</label>
            <input type="password" id="cesiumKey" placeholder="Cesium ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›">
        </div>
        <div class="input-group">
            <label for="locationInput">å ´æ‰€ã®æŒ‡å®š:</label>
            <input type="text" id="locationInput" placeholder="ä¾‹: æ±äº¬ æ¸‹è°·åŒº">
            <button onclick="searchLocation()">æ¤œç´¢</button>
        </div>
        <div class="input-group">
            <label for="radiusInput">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¯„å›² (m):</label>
            <input type="number" id="radiusInput" value="500" min="100" max="2000">
        </div>
        <button onclick="startSimulation()">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</button>
        <button onclick="pauseSimulation()" id="pauseBtn" disabled>ä¸€æ™‚åœæ­¢</button>
        <button onclick="setTimeSpeed()">æ™‚é–“é€Ÿåº¦: <span id="speed">1x</span></button>
        <div class="warning">
            âš ï¸ APIã‚­ãƒ¼ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚<br>
            å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§APIã‚’å‘¼ã³å‡ºã—ã¦ãã ã•ã„ã€‚
        </div>
    </div>
    
    <div id="info-panel">
        <h3 class="panel-title">ğŸ‘¥ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±</h3>
        <div id="agents-list"></div>
    </div>
    
    <div id="log-panel">
        <h3 class="panel-title">ğŸ“ æ´»å‹•ãƒ­ã‚°</h3>
        <div id="activity-log"></div>
    </div>

    <script>
        let viewer;
        let buildingTileset;
        let simulationArea;
        let agents = [];
        let apiKey = '';
        let cesiumKey = '';
        let simulationRunning = false;
        let simulationPaused = false;
        let timeSpeed = 1;
        let currentTime = 8 * 60; // 8:00 AM in minutes

        // CesiumJSã®åˆæœŸåŒ–
        async function initCesium() {
            cesiumKey = document.getElementById('cesiumKey').value;
            if (!cesiumKey) {
                alert('Cesium ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return false;
            }

            try {
                Cesium.Ion.defaultAccessToken = cesiumKey;
                
                // åœ°å½¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’éåŒæœŸã§ä½œæˆ
                const terrainProvider = await Cesium.createWorldTerrainAsync();
                
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrainProvider: terrainProvider,
                    animation: false,
                    baseLayerPicker: false,
                    fullscreenButton: false,
                    geocoder: false,
                    homeButton: false,
                    infoBox: false,
                    sceneModePicker: false,
                    selectionIndicator: false,
                    timeline: false,
                    navigationHelpButton: false,
                    navigationInstructionsInitiallyVisible: false
                });

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½ç½®ï¼ˆæ±äº¬ï¼‰
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(139.7670, 35.6814, 1000),
                    orientation: {
                        heading: Cesium.Math.toRadians(0),
                        pitch: Cesium.Math.toRadians(-45),
                        roll: 0.0
                    }
                });

                return true;
            } catch (error) {
                console.error('CesiumJSã®åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                alert('CesiumJSã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                return false;
            }
        }

        // å ´æ‰€ã®æ¤œç´¢ã‚’éåŒæœŸé–¢æ•°ã«å¤‰æ›´
        async function searchLocation() {
            // ã¾ãšCesiumJSã®ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’åˆæœŸåŒ–
            if (!viewer) {
                if (!(await initCesium())) {
                    return;
                }
            }

            const locationInput = document.getElementById('locationInput').value;
            if (!locationInput) {
                alert('å ´æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationInput)}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const location = data[0];
                    const longitude = parseFloat(location.lon);
                    const latitude = parseFloat(location.lat);
                    
                    // ã‚«ãƒ¡ãƒ©ã‚’ç§»å‹•
                    viewer.camera.setView({
                        destination: Cesium.Cartesian3.fromDegrees(longitude, latitude, 1000),
                        orientation: {
                            heading: Cesium.Math.toRadians(0),
                            pitch: Cesium.Math.toRadians(-45),
                            roll: 0.0
                        }
                    });

                    // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¯„å›²ã‚’è¨­å®š
                    const radius = parseInt(document.getElementById('radiusInput').value);
                    setSimulationArea(longitude, latitude, radius);
                    
                    // å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                    await loadBuildings(longitude, latitude, radius);
                } else {
                    alert('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                }
            } catch (error) {
                console.error('å ´æ‰€ã®æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                alert('å ´æ‰€ã®æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        async function startSimulation() {
            apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ã¾ãšCesiumJSã®ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’åˆæœŸåŒ–
            if (!viewer) {
                if (!(await initCesium())) {
                    return;
                }
            }

            // å ´æ‰€ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä½ç½®ï¼ˆæ±äº¬ï¼‰ã‚’ä½¿ç”¨
            const locationInput = document.getElementById('locationInput').value;
            if (!locationInput) {
                const defaultLongitude = 139.7670;
                const defaultLatitude = 35.6814;
                const radius = parseInt(document.getElementById('radiusInput').value);
                
                setSimulationArea(defaultLongitude, defaultLatitude, radius);
                await loadBuildings(defaultLongitude, defaultLatitude, radius);
            }

            simulationRunning = true;
            document.getElementById('pauseBtn').disabled = false;
            
            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
            createAgents();
            
            addLog('<span style="color: #4CAF50;">ğŸ¬ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹</span>');
        }

        // å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’éåŒæœŸé–¢æ•°ã«å¤‰æ›´
        async function loadBuildings(longitude, latitude, radius) {
            return new Promise((resolve, reject) => {
                // æ—¢å­˜ã®å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                if (buildingTileset) {
                    viewer.scene.primitives.remove(buildingTileset);
                }

                // æ–°ã—ã„å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                buildingTileset = viewer.scene.primitives.add(
                    new Cesium.Cesium3DTileset({
                        url: Cesium.IonResource.fromAssetId(96188), // OpenStreetMap Buildings
                        maximumScreenSpaceError: 16, // LODã®è©³ç´°åº¦
                        maximumMemoryUsage: 512 // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®åˆ¶é™
                    })
                );

                // å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
                buildingTileset.readyPromise
                    .then(() => {
                        // å»ºç‰©ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¯„å›²ã«åˆ¶é™
                        const boundingSphere = new Cesium.BoundingSphere(
                            Cesium.Cartesian3.fromDegrees(longitude, latitude),
                            radius
                        );
                        buildingTileset.boundingSphere = boundingSphere;
                        resolve();
                    })
                    .catch(reject);
            });
        }

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¯„å›²ã®è¨­å®š
        function setSimulationArea(longitude, latitude, radius) {
            // æ—¢å­˜ã®ç¯„å›²ã‚’å‰Šé™¤
            if (simulationArea) {
                viewer.entities.remove(simulationArea);
            }

            // æ–°ã—ã„ç¯„å›²ã‚’è¿½åŠ 
            simulationArea = viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(longitude, latitude),
                ellipse: {
                    semiMinorAxis: radius,
                    semiMajorAxis: radius,
                    material: new Cesium.ColorMaterialProperty(
                        Cesium.Color.BLUE.withAlpha(0.2)
                    ),
                    outline: true,
                    outlineColor: Cesium.Color.BLUE
                }
            });
        }

        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã®å®Ÿè£…
        class Agent {
            constructor(data, index) {
                this.name = data.name;
                this.age = data.age;
                this.personality = data.personality;
                this.dailyRoutine = data.dailyRoutine;
                this.relationships = {};
                this.memories = [];
                this.energy = 100;
                this.currentLocation = data.home;
                this.targetLocation = null;
                this.isMoving = false;
                this.thoughts = [];
                this.lastInteraction = null;
                this.lastThoughtTime = 0;
                
                // ä½ç½®æƒ…å ±ã‚’åœ°ç†åº§æ¨™ç³»ã§ç®¡ç†
                this.currentPosition = Cesium.Cartesian3.fromDegrees(
                    data.home.longitude,
                    data.home.latitude,
                    0
                );
                
                // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®3Dãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ
                this.createModel();
                
                // ãã®ä»–ã®åˆæœŸåŒ–å‡¦ç†
                this.initializeRelationships();
            }
            
            createModel() {
                if (!viewer) return;
                
                // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®3Dãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ
                const entity = viewer.entities.add({
                    position: this.currentPosition,
                    ellipsoid: {
                        radii: new Cesium.Cartesian3(1.0, 1.0, 1.0),
                        material: Cesium.Color.fromCssColorString(this.personality.color),
                        outline: true,
                        outlineColor: Cesium.Color.BLACK
                    },
                    label: {
                        text: this.name,
                        font: '14px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        outlineWidth: 2,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -10)
                    }
                });
                
                this.entity = entity;
            }
            
            moveToLocation(location) {
                if (!viewer || !this.entity) return;
                
                this.targetLocation = location;
                this.isMoving = true;
                
                // ç›®çš„åœ°ã®åº§æ¨™ã‚’è¨­å®š
                const destination = Cesium.Cartesian3.fromDegrees(
                    location.longitude,
                    location.latitude,
                    0
                );
                
                // ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const startPosition = this.currentPosition;
                const endPosition = destination;
                const duration = 2000; // 2ç§’
                const startTime = Date.now();
                
                const animate = () => {
                    if (!viewer || !this.entity) return;
                    
                    const elapsed = Date.now() - startTime;
                    const fraction = Math.min(elapsed / duration, 1.0);
                    
                    // ç·šå½¢è£œé–“ã§ä½ç½®ã‚’æ›´æ–°
                    const newPosition = Cesium.Cartesian3.lerp(
                        startPosition,
                        endPosition,
                        fraction,
                        new Cesium.Cartesian3()
                    );
                    
                    this.entity.position = newPosition;
                    this.currentPosition = newPosition;
                    
                    if (fraction < 1.0) {
                        requestAnimationFrame(animate);
                    } else {
                        this.onArrival(location);
                    }
                };
                
                animate();
            }
            
            onArrival(location) {
                this.currentLocation = location;
                this.isMoving = false;
                this.targetLocation = null;
                this.energy = Math.max(0, this.energy - 10);
                
                addLog(`<span class="log-movement">ğŸš¶ ${this.name}ãŒ${location.name}ã«åˆ°ç€ã—ã¾ã—ãŸ</span>`);
                this.updateInfoPanel();
            }
            
            initializeRelationships() {
                agents.forEach(otherAgent => {
                    if (otherAgent !== this) {
                        this.relationships[otherAgent.name] = {
                            value: Math.random() * 100,
                            history: []
                        };
                    }
                });
            }
            
            updateInfoPanel() {
                const agentCard = document.getElementById(`agent-${this.name}`);
                if (!agentCard) return;
                
                // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æƒ…å ±ã‚’æ›´æ–°
                agentCard.querySelector('.agent-info-row:nth-child(2)').textContent = 
                    `å ´æ‰€: ${this.currentLocation.name}`;
                agentCard.querySelector('.agent-info-row:nth-child(3)').textContent = 
                    `ã‚¨ãƒãƒ«ã‚®ãƒ¼: ${this.energy}%`;
                
                // æœ€æ–°ã®æ€è€ƒã‚’è¡¨ç¤º
                const thoughtElement = agentCard.querySelector('.agent-thought');
                if (this.thoughts.length > 0) {
                    thoughtElement.textContent = this.thoughts[this.thoughts.length - 1];
                    thoughtElement.style.display = 'block';
                } else {
                    thoughtElement.style.display = 'none';
                }
                
                // é–¢ä¿‚æ€§ãƒãƒ¼ã‚’æ›´æ–°
                const relationshipContainer = agentCard.querySelector('.relationship-info');
                relationshipContainer.innerHTML = '';
                
                Object.entries(this.relationships).forEach(([name, relationship]) => {
                    const relationshipItem = document.createElement('div');
                    relationshipItem.className = 'relationship-item';
                    relationshipItem.innerHTML = `
                        <span>${name}</span>
                        <div class="relationship-bar">
                            <div class="relationship-fill" style="width: ${relationship.value}%"></div>
                        </div>
                    `;
                    relationshipContainer.appendChild(relationshipItem);
                });
            }
            
            async think() {
                if (Date.now() - this.lastThoughtTime < 5000) return; // 5ç§’é–“éš”ã§æ€è€ƒ
                
                const prompt = this.buildThoughtPrompt();
                const thought = await simulateThought(prompt);
                
                // æ€è€ƒã®è§£æ
                const thoughtLines = thought.split('\n');
                const thoughtContent = thoughtLines.find(line => line.startsWith('æ€è€ƒ:'))?.substring(3).trim();
                const actionLine = thoughtLines.find(line => line.startsWith('è¡Œå‹•:'))?.substring(3).trim();
                const reasonLine = thoughtLines.find(line => line.startsWith('ç†ç”±:'))?.substring(3).trim();
                
                if (thoughtContent) {
                    this.thoughts.push(thoughtContent);
                    if (this.thoughts.length > 5) this.thoughts.shift();
                }
                
                if (actionLine) {
                    const [action, target] = actionLine.split(' ');
                    this.executeAction(action, target, reasonLine);
                }
                
                this.lastThoughtTime = Date.now();
                this.updateInfoPanel();
                
                addLog(`<span class="log-thought">ğŸ’­ ${this.name}: ${thoughtContent}</span>`);
            }
            
            buildThoughtPrompt() {
                const timeOfDay = this.getTimeOfDay();
                const nearbyAgents = this.findNearbyAgents();
                const timeOfDayCategory = this.getTimeOfDayCategory();
                
                return `
                    ã‚ãªãŸã¯${this.name}ã¨ã„ã†${this.age}æ­³ã®${this.personality.traits.join('ã€')}ãªæ€§æ ¼ã®äººç‰©ã§ã™ã€‚
                    ç¾åœ¨ã®æ™‚åˆ»ã¯${timeOfDay}ï¼ˆ${timeOfDayCategory}ï¼‰ã§ã™ã€‚
                    ç¾åœ¨ã®å ´æ‰€ã¯${this.currentLocation.name}ã§ã™ã€‚
                    ç¾åœ¨ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯${this.energy}%ã§ã™ã€‚
                    
                    è¿‘ãã«ã„ã‚‹äººç‰©: ${nearbyAgents.map(a => a.name).join('ã€')}
                    
                    ã‚ãªãŸã®æ—¥èª²:
                    ${this.dailyRoutine.map(r => `- ${r.time}: ${r.activity}`).join('\n')}
                    
                    ç¾åœ¨ã®çŠ¶æ³ã‚’è€ƒæ…®ã—ã¦ã€æ¬¡ã«ä½•ã‚’ã™ã‚‹ã‹è€ƒãˆã¦ãã ã•ã„ã€‚
                    ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
                    
                    æ€è€ƒ: [ã‚ãªãŸã®è€ƒãˆ]
                    è¡Œå‹•: [move/interact/rest] [å ´æ‰€å/äººç‰©å]
                    ç†ç”±: [è¡Œå‹•ã‚’é¸ã‚“ã ç†ç”±]
                `;
            }
            
            getTimeOfDay() {
                const hour = Math.floor(currentTime / 60);
                const minute = currentTime % 60;
                return `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            }
            
            getTimeOfDayCategory() {
                const hour = Math.floor(currentTime / 60);
                if (hour >= 5 && hour < 12) return "æœ";
                if (hour >= 12 && hour < 17) return "æ˜¼";
                if (hour >= 17 && hour < 21) return "å¤•æ–¹";
                if (hour >= 21 || hour < 5) return "å¤œ";
            }
            
            findNearbyAgents() {
                return agents.filter(agent => {
                    if (agent === this) return false;
                    if (agent.currentLocation !== this.currentLocation) return false;
                    return true;
                });
            }

            executeAction(action, target, reason) {
                switch (action) {
                    case 'move':
                        const location = this.findLocation(target);
                        if (location) {
                            this.moveToLocation(location);
                            addLog(`<span class="log-movement">ğŸš¶ ${this.name}ãŒ${target}ã¸ç§»å‹•ã—ã¾ã™ï¼ˆç†ç”±: ${reason}ï¼‰</span>`);
                        }
                        break;
                    case 'interact':
                        const agent = this.findAgent(target);
                        if (agent) {
                            this.interactWithAgent(agent);
                            addLog(`<span class="log-interaction">ğŸ‘¥ ${this.name}ãŒ${target}ã¨äº¤æµã—ã¾ã™ï¼ˆç†ç”±: ${reason}ï¼‰</span>`);
                        }
                        break;
                    case 'rest':
                        this.rest();
                        addLog(`<span class="log-movement">ğŸ’¤ ${this.name}ãŒä¼‘æ†©ã—ã¾ã™ï¼ˆç†ç”±: ${reason}ï¼‰</span>`);
                        break;
                }
            }

            findLocation(locationName) {
                // å ´æ‰€ã®æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
                return { name: locationName, longitude: 139.7670, latitude: 35.6814 };
            }

            findAgent(agentName) {
                return agents.find(agent => agent.name === agentName);
            }

            interactWithAgent(otherAgent) {
                if (!otherAgent) return;
                
                // é–¢ä¿‚æ€§ã®æ›´æ–°
                const relationship = this.relationships[otherAgent.name];
                if (relationship) {
                    const change = (Math.random() - 0.5) * 10;
                    relationship.value = Math.max(0, Math.min(100, relationship.value + change));
                    relationship.history.push({
                        time: currentTime,
                        change: change
                    });
                }
                
                // ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æ¶ˆè²»
                this.energy = Math.max(0, this.energy - 5);
            }

            rest() {
                this.energy = Math.min(100, this.energy + 20);
            }
        }

        // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆ
        function createAgents() {
            agents = [];
            
            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿
            const agentData = [
                {
                    name: "ç”°ä¸­å¤ªéƒ",
                    age: 28,
                    personality: {
                        traits: ["ç¤¾äº¤çš„", "å¥½å¥‡å¿ƒæ—ºç››"],
                        color: "#4CAF50"
                    },
                    dailyRoutine: [
                        { time: "8:00", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "9:00", activity: "ä¼šç¤¾ã¸å‡ºå‹¤" },
                        { time: "18:00", activity: "ä¼šç¤¾ã‹ã‚‰å¸°å®…" },
                        { time: "20:00", activity: "è‡ªå®…ã§å¤•é£Ÿ" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7670, latitude: 35.6814 }
                },
                {
                    name: "ä½è—¤èŠ±å­",
                    age: 25,
                    personality: {
                        traits: ["å‡ å¸³é¢", "å†…å‘çš„"],
                        color: "#E91E63"
                    },
                    dailyRoutine: [
                        { time: "7:00", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "8:00", activity: "ä¼šç¤¾ã¸å‡ºå‹¤" },
                        { time: "17:00", activity: "ä¼šç¤¾ã‹ã‚‰å¸°å®…" },
                        { time: "19:00", activity: "è‡ªå®…ã§å¤•é£Ÿ" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7672, latitude: 35.6816 }
                },
                {
                    name: "éˆ´æœ¨ä¸€éƒ",
                    age: 35,
                    personality: {
                        traits: ["ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—", "è²¬ä»»æ„ŸãŒå¼·ã„"],
                        color: "#2196F3"
                    },
                    dailyRoutine: [
                        { time: "6:30", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "7:30", activity: "ä¼šç¤¾ã¸å‡ºå‹¤" },
                        { time: "19:00", activity: "ä¼šç¤¾ã‹ã‚‰å¸°å®…" },
                        { time: "20:00", activity: "è‡ªå®…ã§å¤•é£Ÿ" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7674, latitude: 35.6818 }
                },
                {
                    name: "é«˜æ©‹ç¾å’²",
                    age: 22,
                    personality: {
                        traits: ["æ˜ã‚‹ã„", "ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼"],
                        color: "#FFC107"
                    },
                    dailyRoutine: [
                        { time: "8:30", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "9:30", activity: "å¤§å­¦ã¸é€šå­¦" },
                        { time: "17:00", activity: "ã‚¢ãƒ«ãƒã‚¤ãƒˆ" },
                        { time: "21:00", activity: "è‡ªå®…ã«å¸°å®…" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7676, latitude: 35.6820 }
                },
                {
                    name: "ä¼Šè—¤å¥å¤ª",
                    age: 42,
                    personality: {
                        traits: ["å‡ å¸³é¢", "å‡ å¸³é¢"],
                        color: "#9C27B0"
                    },
                    dailyRoutine: [
                        { time: "7:00", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "8:00", activity: "ä¼šç¤¾ã¸å‡ºå‹¤" },
                        { time: "18:00", activity: "ã‚¸ãƒ ã§é‹å‹•" },
                        { time: "20:00", activity: "è‡ªå®…ã§å¤•é£Ÿ" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7678, latitude: 35.6822 }
                },
                {
                    name: "æ¸¡è¾ºã•ãã‚‰",
                    age: 19,
                    personality: {
                        traits: ["æ´»ç™º", "å†’é™ºå¥½ã"],
                        color: "#FF5722"
                    },
                    dailyRoutine: [
                        { time: "9:00", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "10:00", activity: "å¤§å­¦ã¸é€šå­¦" },
                        { time: "16:00", activity: "éƒ¨æ´»å‹•" },
                        { time: "19:00", activity: "è‡ªå®…ã«å¸°å®…" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7680, latitude: 35.6824 }
                },
                {
                    name: "å±±ç”°éš†",
                    age: 31,
                    personality: {
                        traits: ["å†·é™", "åˆ†æçš„"],
                        color: "#607D8B"
                    },
                    dailyRoutine: [
                        { time: "7:30", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "8:30", activity: "ä¼šç¤¾ã¸å‡ºå‹¤" },
                        { time: "18:30", activity: "ä¼šç¤¾ã‹ã‚‰å¸°å®…" },
                        { time: "19:30", activity: "è‡ªå®…ã§å¤•é£Ÿ" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7682, latitude: 35.6826 }
                },
                {
                    name: "ä¸­æ‘å„ªå­",
                    age: 27,
                    personality: {
                        traits: ["å‰µé€ çš„", "èŠ¸è¡“çš„"],
                        color: "#00BCD4"
                    },
                    dailyRoutine: [
                        { time: "8:00", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "9:00", activity: "ã‚¢ãƒˆãƒªã‚¨ã§åˆ¶ä½œ" },
                        { time: "18:00", activity: "ã‚«ãƒ•ã‚§ã§ä¼‘æ†©" },
                        { time: "20:00", activity: "è‡ªå®…ã«å¸°å®…" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7684, latitude: 35.6828 }
                },
                {
                    name: "å°æ—å¤§è¼”",
                    age: 45,
                    personality: {
                        traits: ["ç©ã‚„ã‹", "æ€æ…®æ·±ã„"],
                        color: "#795548"
                    },
                    dailyRoutine: [
                        { time: "6:00", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "7:00", activity: "æ•£æ­©" },
                        { time: "9:00", activity: "ä¼šç¤¾ã¸å‡ºå‹¤" },
                        { time: "18:00", activity: "è‡ªå®…ã«å¸°å®…" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7686, latitude: 35.6830 }
                },
                {
                    name: "åŠ è—¤çœŸç†",
                    age: 33,
                    personality: {
                        traits: ["æƒ…ç†±çš„", "æ±ºæ–­åŠ›ãŒã‚ã‚‹"],
                        color: "#F44336"
                    },
                    dailyRoutine: [
                        { time: "7:00", activity: "è‡ªå®…ã§æœé£Ÿ" },
                        { time: "8:00", activity: "ä¼šç¤¾ã¸å‡ºå‹¤" },
                        { time: "19:00", activity: "ä¼šç¤¾ã‹ã‚‰å¸°å®…" },
                        { time: "20:00", activity: "è‡ªå®…ã§å¤•é£Ÿ" }
                    ],
                    home: { name: "è‡ªå®…", longitude: 139.7688, latitude: 35.6832 }
                }
            ];
            
            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ä½œæˆã¨æƒ…å ±ãƒ‘ãƒãƒ«ã®æ›´æ–°
            agentData.forEach((data, index) => {
                const agent = new Agent(data, index);
                agents.push(agent);
                
                // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã®ä½œæˆ
                const agentCard = document.createElement('div');
                agentCard.className = 'agent-card';
                agentCard.id = `agent-${data.name}`;
                agentCard.innerHTML = `
                    <div class="agent-name">
                        <span class="agent-status status-active"></span>
                        ${data.name}
                    </div>
                    <div class="agent-info-row">å¹´é½¢: ${data.age}æ­³</div>
                    <div class="agent-info-row">å ´æ‰€: ${data.home.name}</div>
                    <div class="agent-info-row">ã‚¨ãƒãƒ«ã‚®ãƒ¼: 100%</div>
                    <div class="agent-thought" style="display: none;"></div>
                    <div class="relationship-info"></div>
                `;
                
                document.getElementById('agents-list').appendChild(agentCard);
            });
        }

        // æ€è€ƒã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        async function simulateThought(prompt) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [
                            {
                                role: "system",
                                content: "ã‚ãªãŸã¯è‡ªå¾‹çš„ãªAIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚ä¸ãˆã‚‰ã‚ŒãŸçŠ¶æ³ã«åŸºã¥ã„ã¦ã€è‡ªç„¶ãªè¡Œå‹•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('æ€è€ƒã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                return "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
            }
        }

        // ãƒ­ã‚°ã®è¿½åŠ 
        function addLog(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = message;
            
            const logContainer = document.getElementById('activity-log');
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ™‚é–“ã®æ›´æ–°
        function updateTime() {
            if (simulationPaused) return;
            
            currentTime += timeSpeed;
            if (currentTime >= 24 * 60) currentTime = 0;
            
            const hour = Math.floor(currentTime / 60);
            const minute = currentTime % 60;
            const timeString = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            document.getElementById('time-display').textContent = timeString;
            
            // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€è€ƒã‚’æ›´æ–°
            agents.forEach(agent => agent.think());
        }

        // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸€æ™‚åœæ­¢
        function pauseSimulation() {
            simulationPaused = !simulationPaused;
            document.getElementById('pauseBtn').textContent = simulationPaused ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢';
        }

        // æ™‚é–“é€Ÿåº¦ã®è¨­å®š
        function setTimeSpeed() {
            timeSpeed = timeSpeed === 1 ? 5 : 1;
            document.getElementById('speed').textContent = `${timeSpeed}x`;
        }

        // å®šæœŸçš„ãªæ›´æ–°
        setInterval(updateTime, 1000);
    </script>
</body>
</html>