<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MESA (Multi-Entity Simulation Architecture)</title>
    <link rel="stylesheet" href="./css/main.css">
</head>
<body>
    <!-- ローディング画面 -->
    <div id="loading-screen">
        <div class="loading-container">
            <div class="loading-logo">
                <h1>MESA</h1>
                <p>Multi-Entity Simulation Architecture</p>
            </div>
            <div class="loading-spinner">
                <div class="spinner"></div>
            </div>
            <div class="loading-text">
                <div id="loading-message">フィールドを生成中...</div>
                <div id="loading-progress">0%</div>
            </div>
            <div class="loading-details">
                <div id="loading-detail-message">初期化中...</div>
            </div>
        </div>
    </div>

    <div id="canvas-container"></div>
    
    <div class="time-display" id="time-display">
        午前 8:00
        <div id="weather-display" class="weather-display"></div>
    </div>
    
    <div class="camera-target-display" id="cameraTargetDisplay" style="display: none;">
        <span id="cameraTargetName"></span>
    </div>
    
    <div id="control-panel">
        <!-- APIアクセス回数表示（最上部） -->
        <div class="api-call-counter">
            <span>API呼び出し回数: <span id="llmCallCount">0</span></span>
        </div>
        
        <!-- タブナビゲーション -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="api-settings">APIキー設定</button>
            <button class="tab-button" data-tab="simulation-settings">シミュレーション設定</button>
            <button class="tab-button" data-tab="agent-management">エージェント管理</button>
            <button class="tab-button" data-tab="camera-settings">視点設定</button>
            <button class="tab-button" data-tab="road-settings">道路設定</button>
            <button class="tab-button" data-tab="video-generation">動画生成</button>
            <button class="tab-button" data-tab="other-settings">その他</button>
        </div>
        
        <!-- タブコンテンツ -->
        <div class="tab-content">
            <!-- APIキー設定タブ -->
            <div id="api-settings" class="tab-pane active">
                <div class="api-key-section">
                    <input type="password" id="apiKey" placeholder="APIキーまたはURLを入力">
                    <div class="input-group">
                        <label><input type="radio" name="apiProvider" value="openai" checked> OpenAI</label>
                        <label><input type="radio" name="apiProvider" value="gemini"> Gemini</label>
                        <label><input type="radio" name="apiProvider" value="ollama"> Ollama (ローカル)</label>
                    </div>
                    
                    <div id="ollamaSettings" style="display: none; margin-top: 10px;">
                        <label for="ollamaUrl">Ollama URL:</label>
                        <input type="text" id="ollamaUrl" placeholder="http://localhost:11434" value="http://localhost:11434">
                        <label for="ollamaModel">モデル名:</label>
                        <input type="text" id="ollamaModel" placeholder="llama3.2" value="llama3.2">
                    </div>

                    <div class="warning">
                        ⚠️ APIキーはlocalStorageに保存されます。
                    </div>
                </div>
            </div>
            
            <!-- シミュレーション設定タブ -->
            <div id="simulation-settings" class="tab-pane">
                <div class="simulation-controls">
                    <button id="startSimulationBtn">シミュレーション開始</button>
                    <button id="pauseBtn" disabled>一時停止</button>
                    <button id="timeSpeedBtn">時間速度: <span id="speed">1x</span></button>
                </div>
            </div>
            
            <!-- エージェント管理タブ -->
            <div id="agent-management" class="tab-pane">
                <div class="agent-creation">
                    <div class="agent-input-section">
                        <label for="agentCustomPrompt">エージェントの希望条件（任意）:</label>
                        <textarea id="agentCustomPrompt" placeholder="例: 30代の女性、看護師、明るい性格&#10;例: 20代の男性、学生、内向的だが親切&#10;例: 40代の男性、会社員、責任感が強い&#10;例: 50代の女性、主婦、地域活動に熱心" rows="3" style="width: 100%; margin-bottom: 10px;"></textarea>
                    </div>
                    <button onclick="generateNewAgent()" id="generateAgentBtn">新しいエージェントを生成</button>
                </div>
                <div class="agent-storage-controls">
                    <button onclick="loadSavedAgents()" id="loadAgentsBtn">保存されたエージェントを読み込み</button>
                    <button onclick="clearAllAgents()" id="clearAgentsBtn">全エージェントを削除</button>
                    <button id="exportAgentsBtn">エージェント書き出し</button>
                    <button id="importAgentsBtn">エージェント読み込み</button>
                    <input type="file" id="importAgentsFile" accept="application/json" style="display:none">
                </div>
                <div id="generationStatus" style="display: none; margin-top: 10px; padding: 10px; background-color: #f0f8ff; border: 1px solid #007acc; border-radius: 5px; text-align: center;">
                    <div id="generationMessage">エージェントを生成中...</div>
                    <div id="generationProgress" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
            
            <!-- 視点設定タブ -->
            <div id="camera-settings" class="tab-pane">
                <div class="camera-controls">
                    <div class="camera-status">
                        <span id="cameraModeDisplay">全体表示</span>
                    </div>
                    <button id="personViewBtn">人物視点切り替え</button>
                    <button id="facilityViewBtn">施設視点切り替え</button>
                    <button id="resetCamera">全体表示</button>
                </div>
                <div class="communication-controls">
                    <button id="callAgentBtn" disabled>📞 電話をかける</button>
                    <button id="messageAgentBtn" disabled>💬 メッセージを送る</button>
                </div>
            </div>
            
            <!-- 道路設定タブ -->
            <div id="road-settings" class="tab-pane">
                <div class="road-visualization">
                    <button id="toggleRoadNetwork">道路ネットワーク表示</button>
                    <button id="clearRoadVisualization">道路表示クリア</button>
                    <button id="toggleEntranceConnections">入り口接続情報</button>
                </div>
                <div class="vehicle-controls">
                    <h4>🚗 車両システム</h4>
                    <div class="vehicle-settings">
                        <label for="vehicleCount">最大車両数: <span id="currentVehicleCount">15</span></label>
                        <input type="range" id="vehicleCount" min="0" max="30" value="15" style="width: 100%;">
                    </div>
                    <div class="vehicle-stats">
                        <div>現在の車両数: <span id="vehicleStatsCurrent">0</span></div>
                        <div>生成間隔: <span id="vehicleStatsInterval">2.0</span>秒</div>
                    </div>
                    <div class="vehicle-buttons">
                        <button id="clearAllVehiclesBtn">全車両削除</button>
                        <button id="toggleVehicleSystemBtn">車両システムON/OFF</button>
                    </div>
                </div>
            </div>
            
            <!-- 動画生成タブ -->
            <div id="video-generation" class="tab-pane">
                <div class="video-generation-panel">
                    <h3>動画生成設定</h3>
                    
                    <div class="setting-group">
                        <h4>Veo Server設定</h4>
                        <div class="input-group">
                            <label for="veoServerUrl">Veo Server URL:</label>
                            <input type="text" id="veoServerUrl" placeholder="http://localhost:3000" />
                        </div>
                        <div class="input-group">
                            <label for="veoApiKey">API Key (オプション):</label>
                            <input type="password" id="veoApiKey" placeholder="APIキーを入力" />
                        </div>
                        <button id="testVeoConnection" class="btn btn-secondary">接続テスト</button>
                        <div id="connectionStatus" class="status-indicator"></div>
                    </div>

                    <div class="setting-group">
                        <h4>録画設定</h4>
                        <div class="input-group">
                            <label for="recordingDuration">録画時間 (秒):</label>
                            <input type="number" id="recordingDuration" value="10" min="5" max="60" />
                        </div>
                        <div class="input-group">
                            <label for="frameRate">フレームレート (fps):</label>
                            <input type="number" id="frameRate" value="30" min="15" max="60" />
                        </div>
                        <div class="input-group">
                            <label for="videoQuality">画質:</label>
                            <select id="videoQuality">
                                <option value="low">低画質 (推奨)</option>
                                <option value="medium">中画質</option>
                                <option value="high">高画質</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-group">
                        <h4>録画対象</h4>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" id="recordAgents" checked />
                                エージェントの動き
                            </label>
                            <label>
                                <input type="checkbox" id="recordVehicles" checked />
                                車両の動き
                            </label>
                            <label>
                                <input type="checkbox" id="recordWeather" checked />
                                天候エフェクト
                            </label>
                            <label>
                                <input type="checkbox" id="recordUI" />
                                UI要素
                            </label>
                        </div>
                    </div>

                    <div class="setting-group">
                        <h4>動画生成指示</h4>
                        <div class="input-group">
                            <label for="videoStyle">動画スタイル:</label>
                            <select id="videoStyle">
                                <option value="auto">自動選択</option>
                                <option value="documentary">ドキュメンタリー風</option>
                                <option value="cinematic">映画風</option>
                                <option value="news">ニュース風</option>
                                <option value="vlog">Vlog風</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="videoFocus">焦点:</label>
                            <select id="videoFocus">
                                <option value="auto">自動選択</option>
                                <option value="agents">エージェントの行動</option>
                                <option value="interactions">エージェント間の交流</option>
                                <option value="locations">場所の活動</option>
                                <option value="daily">日常の風景</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="videoMood">雰囲気:</label>
                            <select id="videoMood">
                                <option value="auto">自動選択</option>
                                <option value="warm">温かみのある</option>
                                <option value="lively">活気に満ちた</option>
                                <option value="peaceful">静かな</option>
                                <option value="dynamic">動的な</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="customVideoPrompt">カスタム指示 (任意):</label>
                            <textarea id="customVideoPrompt" placeholder="例: この街の朝の風景を、温かみのある雰囲気で撮影してください&#10;例: エージェントの交流を中心に、活気に満ちた街の様子を表現してください" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="recording-controls">
                        <button id="startRecording" class="btn btn-primary">録画開始</button>
                        <button id="stopRecording" class="btn btn-danger" disabled>録画停止</button>
                        <button id="generateVideo" class="btn btn-success" disabled>動画生成</button>
                    </div>

                    <div class="recording-status">
                        <div id="recordingProgress" class="progress-bar">
                            <div id="recordingProgressFill" class="progress-fill"></div>
                        </div>
                        <div id="recordingInfo" class="recording-info"></div>
                    </div>

                    <div class="video-preview">
                        <h4>生成された動画</h4>
                        <div id="videoPreview" class="video-preview-container">
                            <p>録画が完了すると、ここに動画が表示されます。</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- その他タブ -->
            <div id="other-settings" class="tab-pane">
                <div class="other-controls">
                    <div class="prompt-section">
                        <label for="topicPrompt">話題のテーマ:</label>
                        <textarea id="topicPrompt" placeholder="例: テーマ、社会課題について&#10;例: 環境問題、地域コミュニティについて&#10;例: 健康、ライフスタイルについて" rows="3"></textarea>
                    </div>
                    
                    <div class="field-color-section">
                        <h4>🎨 フィールド色設定</h4>
                        <div class="color-buttons">
                            <button class="color-btn" data-color="green" style="background-color: #B8E6B8;">グリーン</button>
                            <button class="color-btn" data-color="purple" style="background-color: #8B5A8B; color: white;">パープル</button>
                            <button class="color-btn" data-color="black" style="background-color: #2d2d2d; color: white;">ブラック</button>
                            <button class="color-btn" data-color="blue" style="background-color: #B8E6F0;">ブルー</button>
                            <button class="color-btn" data-color="orange" style="background-color: #F0E6B8;">オレンジ</button>
                            <button class="color-btn" data-color="pink" style="background-color: #F0B8E6;">ピンク</button>
                            <button class="color-btn" data-color="gray" style="background-color: #C0C0C0;">グレー</button>
                            <button class="color-btn" data-color="brown" style="background-color: #D2B48C;">ブラウン</button>
                        </div>
                    </div>
                    
                    <p>その他の設定や機能をここに配置</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="info-panel">
        <div id="agents-list">
            <div id="agentList"></div>
        </div>
    </div>
    
    <div id="log-panel">
        <div id="activity-log"></div>
    </div>

    <button id="showPanelsBtn" style="position:fixed; left:10px; bottom:10px; z-index:9999; display:none; font-size:13px;">パネル再表示</button>

    <!-- メッセージモーダル -->
    <div id="messageModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="messageModalTitle">メッセージ</h3>
                <span class="close" id="closeMessageModal">&times;</span>
            </div>
            <div class="modal-body">
                <div id="messageHistory" class="message-history"></div>
                <div class="message-input-area">
                    <textarea id="messageInput" placeholder="メッセージを入力してください..." rows="3"></textarea>
                    <div class="message-buttons">
                        <button id="sendMessageBtn">送信</button>
                        <button id="clearMessageBtn" onclick="clearCurrentMessageHistory()">履歴クリア</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- エージェント詳細モーダル -->
    <div id="agentDetailModal" class="modal" style="display: none;">
        <div class="modal-content agent-detail-modal">
            <div class="modal-header">
                <h3 id="agentDetailModalTitle">エージェント詳細</h3>
                <span class="close" id="closeAgentDetailModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="agent-detail-tabs">
                    <button class="tab-button active" data-tab="summary">サマリ</button>
                    <button class="tab-button" data-tab="movement">移動履歴</button>
                    <button class="tab-button" data-tab="actions">行動履歴</button>
                    <button class="tab-button" data-tab="thoughts">思考履歴</button>
                    <button class="tab-button" data-tab="charts">チャート</button>
                </div>
                
                <div class="tab-content">
                    <!-- サマリタブ -->
                    <div id="summary-tab" class="tab-pane active">
                        <div class="agent-summary">
                            <div class="agent-basic-info">
                                <h4>基本情報</h4>
                                <div id="agentBasicInfo"></div>
                            </div>
                            <div class="agent-stats">
                                <h4>統計情報</h4>
                                <div id="agentStats"></div>
                            </div>
                            <div class="agent-relationships">
                                <h4>関係性</h4>
                                <div id="agentRelationships"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 移動履歴タブ -->
                    <div id="movement-tab" class="tab-pane">
                        <div class="movement-history">
                            <h4>移動履歴</h4>
                            <div id="movementHistory"></div>
                        </div>
                    </div>
                    
                    <!-- 行動履歴タブ -->
                    <div id="actions-tab" class="tab-pane">
                        <div class="action-history">
                            <h4>行動履歴</h4>
                            <div id="actionHistory"></div>
                        </div>
                    </div>
                    
                    <!-- 思考履歴タブ -->
                    <div id="thoughts-tab" class="tab-pane">
                        <div class="thought-history">
                            <h4>思考履歴</h4>
                            <div id="thoughtHistory"></div>
                        </div>
                    </div>
                    
                    <!-- チャートタブ -->
                    <div id="charts-tab" class="tab-pane">
                        <div class="charts-container">
                            <div class="chart-section">
                                <h4>移動パターン</h4>
                                <canvas id="movementChart" width="400" height="200"></canvas>
                            </div>
                            <div class="chart-section">
                                <h4>行動分布</h4>
                                <canvas id="actionChart" width="400" height="200"></canvas>
                            </div>
                            <div class="chart-section">
                                <h4>気分変化</h4>
                                <canvas id="moodChart" width="400" height="200"></canvas>
                            </div>
                            <div class="chart-section">
                                <h4>エネルギー変化</h4>
                                <canvas id="energyChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- コアシステム -->
    <script src="./src/core/config.js"></script>
    <script src="./src/core/log.js"></script>
    <script src="./src/core/camera-system.js"></script>
    <script src="./src/core/main.js"></script>
    
    <!-- エージェントシステム -->
    <script src="./src/agents/agent-utils.js"></script>
    <script src="./src/agents/agent-home.js"></script>
    <script src="./src/agents/agent-storage.js"></script>
    <script src="./src/agents/agent-generation.js"></script>
    <script src="./src/agents/agent-interaction.js"></script>
    <script src="./src/agents/agent-movement.js"></script>
    <script src="./src/agents/agent-core.js"></script>
    
    <!-- 都市システム -->
    <script src="./src/city/buildings.js"></script>
    <script src="./src/city/road-system.js"></script>
    <script src="./src/city/building-system.js"></script>
    <script src="./src/city/facility-system.js"></script>
    <script src="./src/city/city-layout-manager.js"></script>
    
    <!-- 各種システム -->
    <script src="./src/systems/pathfinding-system.js"></script>
    <script src="./src/systems/visualization-system.js"></script>
    <script src="./src/systems/weather.js"></script>
    <script src="./src/systems/vehicles.js"></script>
    <script src="./src/systems/video-generation-system.js"></script>
    
    <!-- UIシステム -->
    <script src="./src/ui/character.js"></script>
    <script src="./src/ui/panel.js"></script>
</body>
</html>